---
import { themeConfig } from '~/.config'

const theme = themeConfig.appearance.theme
---

<script is:inline define:vars={{ theme }}>
  ;(() => {
    const storageKey = 'theme-preference'
    const media = window.matchMedia('(prefers-color-scheme: dark)')

    const resolveDark = (mode) => mode === 'dark' || (mode === 'system' && media.matches)

    const getPreferred = () => {
      const saved = localStorage.getItem(storageKey)
      if (saved === 'light' || saved === 'dark' || saved === 'system') {
        return saved
      }
      return theme
    }

    const apply = (mode) => {
      const dark = resolveDark(mode)
      document.documentElement.classList.toggle('dark', dark)
      document.documentElement.dataset.theme = mode
      window.dispatchEvent(new CustomEvent('themechange', { detail: { mode, dark } }))
    }

    const setPreferred = (mode) => {
      localStorage.setItem(storageKey, mode)
      apply(mode)
    }

    window.__theme = {
      get: getPreferred,
      set: setPreferred,
      apply,
    }

    apply(getPreferred())

    media.addEventListener('change', () => {
      if (getPreferred() === 'system') {
        apply('system')
      }
    })
  })()
</script>
